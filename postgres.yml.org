- hosts: eea-3
  remote_user: ubuntu
  become: true
  become_method: sudo
  become_user: root

  tasks:
    - name: add apt key
      apt_key: url=https://postgresql.org/media/keys/ACCC4CF8.asc state=present 
      environment:
        https_proxy: http://10.175.250.81:8080

    - name: add apt repository
      apt_repository: repo='deb https://apt.postgresql.org/pub/repos/apt/ trusty-pgdg main' state=present update_cache='yes'

    - name: apt install postgres
      apt: name='postgresql-9.4' state='present' update_cache='yes'

    - name: set password for postgres 
      postgresql_user:
        db: postgres
        user: postgres
        password: postgres

    #- name: install pexpect via pip
    #  pip: name=pexpect
    #  environment:
    #    https_proxy: http://10.175.250.81:8080
    #    http_proxy: http://10.175.250.81:8080


    #- name: set password for posgres via expect
    #  expect:
    #    command: sudo -u postgres psql postgres --command '\password postgres'
    #    responses:
    #      'Enter new password:': 'postgres'
    #      'Enter it again:': 'postgres'
    #    echo: yes
    #  tags: expect

    - name: change postgre pg_hba.conf
      lineinfile:
        dest: /etc/postgresql/9.4/main/pg_hba.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      with_items:
        - { regexp: '^local.+peer$', line: 'local all all trust' }
      tags: multiC

    - name: change postgresql.conf
      lineinfile:
        dest: /etc/postgresql/9.4/main/postgresql.conf
        regexp: "^#listen_addresses = 'localhost'"
        line: "listen_addresses = '*'"
        backup: yes
      tags: listen_port

    - name: restart postgresql service
      service: name=postgresql state=restarted
